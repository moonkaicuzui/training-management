import{q as P,r as v,s as b,t as B,v as D,w as R,x as I,y as F,z,A as T,E as C,F as O}from"./index-DaEJbrWA.js";const _=r=>r,x=r=>r,M=r=>r,j=r=>r,w=r=>r,y=r=>r,A=r=>r,N=r=>({...r,program_code:r.program_code,tags:Object.freeze([...r.tags]),target_positions:Object.freeze([...r.target_positions]),grade_thresholds:{aa:r.grade_aa,a:r.grade_a,b:r.grade_b},created_at:r.created_at,updated_at:r.updated_at}),L=r=>({employee_id:_(r.employee_id),employee_name:r.employee_name,department:r.department,position:r.position,building:r.building,line:r.line,hire_date:w(r.hire_date),status:r.status,updated_at:y(r.updated_at)}),U=r=>({session_id:M(r.session_id),program_code:x(r.program_code),session_date:w(r.session_date),session_time:A(r.session_time),trainer:{name:r.trainer_name||r.trainer,employee_id:void 0},location:r.location,max_attendees:r.max_attendees,attendees:Object.freeze(r.attendees.map(_)),status:r.status,notes:r.notes,created_by:r.created_by,created_at:y(r.created_at)}),G=r=>({result_id:j(r.result_id),session_id:r.session_id?M(r.session_id):null,employee_id:_(r.employee_id),program_code:x(r.program_code),training_date:w(r.training_date),score:r.score,grade:r.grade,result:r.result,needs_retraining:r.needs_retraining,evaluated_by:r.evaluated_by,remarks:r.remarks,created_at:y(r.created_at),updated_at:r.updated_at?y(r.updated_at):null,updated_by:r.updated_by}),u=r=>r.map(L),m=r=>r.map(N),H=r=>r.map(U),f=r=>r.map(G),S={entities:{employees:new Map,programs:new Map,sessions:new Map,results:new Map},indexes:{resultsByEmployee:new Map,resultsByProgram:new Map,sessionsByProgram:new Map,resultsBySession:new Map},ui:{selectedEmployeeId:null,selectedProgramCode:null,selectedSessionId:null},filters:{employees:{},programs:{},sessions:{},results:{},progressMatrix:{}},loading:{entities:{employees:!1,programs:!1,sessions:!1,results:!1},views:{dashboard:!1,progressMatrix:!1,retraining:!1}},derived:{dashboard:{stats:null,monthlyData:[],gradeDistribution:[]},progressMatrix:null,retraining:{targets:[],expiring:[]}}},E=P()(v((r,l)=>({...S,fetchEmployees:async e=>{r(s=>({loading:{...s.loading,entities:{...s.loading.entities,employees:!0}}}));try{const s=e?{department:e.department,position:e.position,building:e.building,line:e.line,status:e.status,search:e.search}:{},t=await O(s),n=u(t),o=new Map;n.forEach(i=>o.set(i.employee_id,i)),r(i=>({entities:{...i.entities,employees:o},filters:{...i.filters,employees:e||{}}}))}catch(s){throw console.error("Failed to fetch employees:",s),s}finally{r(s=>({loading:{...s.loading,entities:{...s.loading.entities,employees:!1}}}))}},getEmployee:e=>l().entities.employees.get(e),setSelectedEmployee:e=>{r(s=>({ui:{...s.ui,selectedEmployeeId:e}}))},addEmployee:e=>{r(s=>{const t=new Map(s.entities.employees);return t.set(e.employee_id,e),{entities:{...s.entities,employees:t}}})},updateEmployee:(e,s)=>{r(t=>{const n=t.entities.employees.get(e);if(!n)return t;const o={...n,...s},i=new Map(t.entities.employees);return i.set(e,o),{entities:{...t.entities,employees:i}}})},fetchPrograms:async e=>{r(s=>({loading:{...s.loading,entities:{...s.loading.entities,programs:!0}}}));try{const s=e?{category:e.category,showInactive:e.showInactive,search:e.search,tags:e.tags?[...e.tags]:void 0}:{},t=await C(s),n=m(t),o=new Map;n.forEach(i=>o.set(i.program_code,i)),r(i=>({entities:{...i.entities,programs:o},filters:{...i.filters,programs:e||{}}}))}catch(s){throw console.error("Failed to fetch programs:",s),s}finally{r(s=>({loading:{...s.loading,entities:{...s.loading.entities,programs:!1}}}))}},getProgram:e=>l().entities.programs.get(e),setSelectedProgram:e=>{r(s=>({ui:{...s.ui,selectedProgramCode:e}}))},addProgram:e=>{r(s=>{const t=new Map(s.entities.programs);return t.set(e.program_code,e),{entities:{...s.entities,programs:t}}})},updateProgram:(e,s)=>{r(t=>{const n=t.entities.programs.get(e);if(!n)return t;const o={...n,...s},i=new Map(t.entities.programs);return i.set(e,o),{entities:{...t.entities,programs:i}}})},deactivateProgram:e=>{l().updateProgram(e,{is_active:!1})},fetchSessions:async e=>{r(s=>({loading:{...s.loading,entities:{...s.loading.entities,sessions:!0}}}));try{const s=e?{startDate:e.startDate,endDate:e.endDate,programCode:e.programCode,status:e.status}:{},t=await T(s),n=H(t),o=new Map,i=new Map;n.forEach(g=>{o.set(g.session_id,g);const d=i.get(g.program_code)||new Set;d.add(g.session_id),i.set(g.program_code,d)}),r(g=>({entities:{...g.entities,sessions:o},indexes:{...g.indexes,sessionsByProgram:i},filters:{...g.filters,sessions:e||{}}}))}catch(s){throw console.error("Failed to fetch sessions:",s),s}finally{r(s=>({loading:{...s.loading,entities:{...s.loading.entities,sessions:!1}}}))}},getSession:e=>l().entities.sessions.get(e),setSelectedSession:e=>{r(s=>({ui:{...s.ui,selectedSessionId:e}}))},addSession:e=>{r(s=>{const t=new Map(s.entities.sessions);t.set(e.session_id,e);const n=new Map(s.indexes.sessionsByProgram),o=n.get(e.program_code)||new Set;return o.add(e.session_id),n.set(e.program_code,o),{entities:{...s.entities,sessions:t},indexes:{...s.indexes,sessionsByProgram:n}}})},updateSession:(e,s)=>{r(t=>{const n=t.entities.sessions.get(e);if(!n)return t;const o={...n,...s},i=new Map(t.entities.sessions);return i.set(e,o),{entities:{...t.entities,sessions:i}}})},cancelSession:e=>{l().updateSession(e,{status:"CANCELLED"})},fetchResults:async e=>{r(s=>({loading:{...s.loading,entities:{...s.loading.entities,results:!0}}}));try{const s=e?{employeeId:e.employeeId,programCode:e.programCode,startDate:e.startDate,endDate:e.endDate,result:e.result,grade:e.grade}:{},t=await z(s),n=f(t),o=new Map,i=new Map,g=new Map,d=new Map;n.forEach(a=>{o.set(a.result_id,a);const c=i.get(a.employee_id)||new Set;c.add(a.result_id),i.set(a.employee_id,c);const p=g.get(a.program_code)||new Set;if(p.add(a.result_id),g.set(a.program_code,p),a.session_id){const h=d.get(a.session_id)||new Set;h.add(a.result_id),d.set(a.session_id,h)}}),r(a=>({entities:{...a.entities,results:o},indexes:{...a.indexes,resultsByEmployee:i,resultsByProgram:g,resultsBySession:d},filters:{...a.filters,results:e||{}}}))}catch(s){throw console.error("Failed to fetch results:",s),s}finally{r(s=>({loading:{...s.loading,entities:{...s.loading.entities,results:!1}}}))}},getResult:e=>l().entities.results.get(e),addResult:e=>{r(s=>{const t=new Map(s.entities.results);t.set(e.result_id,e);const n={...s.indexes},o=n.resultsByEmployee.get(e.employee_id)||new Set;o.add(e.result_id),n.resultsByEmployee=new Map(n.resultsByEmployee),n.resultsByEmployee.set(e.employee_id,o);const i=n.resultsByProgram.get(e.program_code)||new Set;if(i.add(e.result_id),n.resultsByProgram=new Map(n.resultsByProgram),n.resultsByProgram.set(e.program_code,i),e.session_id){const g=n.resultsBySession.get(e.session_id)||new Set;g.add(e.result_id),n.resultsBySession=new Map(n.resultsBySession),n.resultsBySession.set(e.session_id,g)}return{entities:{...s.entities,results:t},indexes:n}})},updateResult:(e,s)=>{r(t=>{const n=t.entities.results.get(e);if(!n)return t;const o={...n,...s},i=new Map(t.entities.results);return i.set(e,o),{entities:{...t.entities,results:i}}})},getEmployeeHistory:e=>{const s=l().indexes.resultsByEmployee.get(e)||new Set,t=[];return s.forEach(n=>{const o=l().entities.results.get(n);o&&t.push(o)}),t.sort((n,o)=>o.training_date.localeCompare(n.training_date))},getProgramResults:e=>{const s=l().indexes.resultsByProgram.get(e)||new Set,t=[];return s.forEach(n=>{const o=l().entities.results.get(n);o&&t.push(o)}),t.sort((n,o)=>o.training_date.localeCompare(n.training_date))},getSessionResults:e=>{const s=l().indexes.resultsBySession.get(e)||new Set,t=[];return s.forEach(n=>{const o=l().entities.results.get(n);o&&t.push(o)}),t},getProgramSessions:e=>{const s=l().indexes.sessionsByProgram.get(e)||new Set,t=[];return s.forEach(n=>{const o=l().entities.sessions.get(n);o&&t.push(o)}),t.sort((n,o)=>o.session_date.localeCompare(n.session_date))},setEmployeeFilters:e=>{r(s=>({filters:{...s.filters,employees:e}})),l().fetchEmployees(e)},setProgramFilters:e=>{r(s=>({filters:{...s.filters,programs:e}})),l().fetchPrograms(e)},setSessionFilters:e=>{r(s=>({filters:{...s.filters,sessions:e}})),l().fetchSessions(e)},setResultFilters:e=>{r(s=>({filters:{...s.filters,results:e}})),l().fetchResults(e)},setProgressFilters:e=>{r(s=>({filters:{...s.filters,progressMatrix:e}})),l().fetchProgressMatrix(e)},clearAllFilters:()=>{r({filters:{employees:{},programs:{},sessions:{},results:{},progressMatrix:{}}})},fetchDashboardStats:async()=>{r(e=>({loading:{...e.loading,views:{...e.loading.views,dashboard:!0}}}));try{const e=await F();r(s=>({derived:{...s.derived,dashboard:{...s.derived.dashboard,stats:e}}}))}catch(e){throw console.error("Failed to fetch dashboard stats:",e),e}finally{r(e=>({loading:{...e.loading,views:{...e.loading.views,dashboard:!1}}}))}},fetchMonthlyData:async()=>{try{const e=await I();r(s=>({derived:{...s.derived,dashboard:{...s.derived.dashboard,monthlyData:e}}}))}catch(e){throw console.error("Failed to fetch monthly data:",e),e}},fetchGradeDistribution:async()=>{try{const e=await R();r(s=>({derived:{...s.derived,dashboard:{...s.derived.dashboard,gradeDistribution:e}}}))}catch(e){throw console.error("Failed to fetch grade distribution:",e),e}},fetchProgressMatrix:async e=>{r(s=>({loading:{...s.loading,views:{...s.loading.views,progressMatrix:!0}}}));try{const s=e?{building:e.building,department:e.department,line:e.line,position:e.position,category:e.category}:{},t=await D(s),n=u(t.employees),o=m(t.programs),i={},g=[];for(const d of t.cells){const a=d.employeeId,c=d.programCode,p={employee_id:a,program_code:c,status:d.status,last_result:d.lastResult?.result||null,last_score:d.lastResult?.score||null,last_grade:d.lastResult?.grade||null,last_training_date:d.lastResult?.training_date||null,expiration_date:d.expirationDate||null,days_until_expiry:d.expirationDate?Math.ceil((new Date(d.expirationDate).getTime()-Date.now())/(1e3*60*60*24)):null,completion_count:1};g.push(p),i[a]||(i[a]={}),i[a][c]=p}r(d=>({derived:{...d.derived,progressMatrix:{employees:Object.freeze(n),programs:Object.freeze(o),cells:Object.freeze(g),matrix:Object.freeze(i)}},filters:{...d.filters,progressMatrix:e||{}}}))}catch(s){throw console.error("Failed to fetch progress matrix:",s),s}finally{r(s=>({loading:{...s.loading,views:{...s.loading.views,progressMatrix:!1}}}))}},fetchRetrainingTargets:async()=>{r(e=>({loading:{...e.loading,views:{...e.loading.views,retraining:!0}}}));try{const s=(await B()).map(t=>({employee:u([t.employee])[0],program:m([t.program])[0],last_result:f([t.lastResult])[0],reason:t.reason,priority:t.reason==="FAILED"?"HIGH":t.reason==="EXPIRED"?"MEDIUM":"LOW",recommended_programs:t.recommendedPrograms?Object.freeze(m(t.recommendedPrograms)):void 0}));r(t=>({derived:{...t.derived,retraining:{...t.derived.retraining,targets:s}}}))}catch(e){throw console.error("Failed to fetch retraining targets:",e),e}finally{r(e=>({loading:{...e.loading,views:{...e.loading.views,retraining:!1}}}))}},fetchExpiringTrainings:async(e=30)=>{try{const t=(await b(e)).map(n=>({employee:u([n.employee])[0],program:m([n.program])[0],last_pass_date:n.lastPassDate,expiration_date:n.expirationDate,days_until_expiry:n.daysUntilExpiry,priority:n.daysUntilExpiry<=7?"URGENT":n.daysUntilExpiry<=14?"SOON":"NORMAL"}));r(n=>({derived:{...n.derived,retraining:{...n.derived.retraining,expiring:t}}}))}catch(s){throw console.error("Failed to fetch expiring trainings:",s),s}},rebuildIndexes:()=>{r(e=>{const s={resultsByEmployee:new Map,resultsByProgram:new Map,sessionsByProgram:new Map,resultsBySession:new Map};return e.entities.results.forEach(t=>{const n=s.resultsByEmployee.get(t.employee_id)||new Set;n.add(t.result_id),s.resultsByEmployee.set(t.employee_id,n);const o=s.resultsByProgram.get(t.program_code)||new Set;if(o.add(t.result_id),s.resultsByProgram.set(t.program_code,o),t.session_id){const i=s.resultsBySession.get(t.session_id)||new Set;i.add(t.result_id),s.resultsBySession.set(t.session_id,i)}}),e.entities.sessions.forEach(t=>{const n=s.sessionsByProgram.get(t.program_code)||new Set;n.add(t.session_id),s.sessionsByProgram.set(t.program_code,n)}),{indexes:s}})},clearAllData:()=>{r(S)}}),{name:"NormalizedTrainingStore"})),q=()=>E(r=>({employees:Array.from(r.entities.employees.values()),loading:r.loading.entities.employees,filters:r.filters.employees})),W=()=>E(r=>({progressMatrix:r.derived.progressMatrix,loading:r.loading.views.progressMatrix,filters:r.filters.progressMatrix}));export{W as a,q as b,E as u};
