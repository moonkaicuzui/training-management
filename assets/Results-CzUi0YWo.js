import{j as e}from"./vendor-ui-3vVLwvSG.js";import{r as m}from"./vendor-react-3RSvEdhP.js";import{g as Ae,h as Re,C as G,a as U,b as W,d as J,e as K,I as y,f as R,B as f}from"./index-DbE0N-7e.js";import{T as X,a as Y,b as D,c as i,d as Z,e as c}from"./table-C47-Z7GG.js";import{S as E,a as k,b as T,c as L,d as o}from"./select-B9RdTlAY.js";import{D as ee,a as se,b as ae,c as ne,d as te,e as re}from"./dialog-D5PoXStQ.js";import{L as _}from"./label-Dcyga6z7.js";import{T as De}from"./textarea-DKXFBtN7.js";import{P as Ee}from"./LoadingSpinner-C546iy_4.js";import{u as ke}from"./vendor-i18n-BmxLmPQ7.js";import{N as le,S as Te,y as Le,H as Pe,T as Be}from"./vendor-icons-B-g4Br4W.js";import{f as P}from"./vendor-utils-CC1vNFCq.js";import"./vendor-charts-B2i3rig-.js";function Je(){const{t:n}=ke(),{sessions:I,programs:ie,employees:B,results:M,loading:S,fetchSessions:ce,fetchPrograms:de,fetchEmployees:oe,fetchResults:H,recordResults:me,updateResult:xe}=Ae(),{addToast:x}=Re(),[C,O]=m.useState(""),[h,j]=m.useState([]),[he,b]=m.useState(!1),[l,p]=m.useState(null),[ue,v]=m.useState(!1),[u,V]=m.useState([]),[w,$]=m.useState([]),[A,ge]=m.useState(""),[F,je]=m.useState("all");m.useEffect(()=>{ce({status:"PLANNED"}),de({}),oe({}),H({})},[]);const d=I.find(s=>s.session_id===C),g=d?ie.find(s=>s.program_code===d.program_code):null;m.useEffect(()=>{if(d&&d.attendees.length>0){const s=d.attendees.map(t=>{const a=B.find(r=>r.employee_id===t);return{employee_id:t,employee_name:a?.employee_name||t,score:null,result:"PASS",remarks:""}});j(s)}else j([])},[C,d,B]);const Q=M.filter(s=>{const t=A===""||s.employee_id.toLowerCase().includes(A.toLowerCase())||s.program_code.toLowerCase().includes(A.toLowerCase()),a=F==="all"||s.result===F;return t&&a}),pe=(s,t)=>{const a=[...h],r=t===""?null:parseInt(t);a[s].score=r,g&&r!==null&&(a[s].result=r>=g.passing_score?"PASS":"FAIL"),j(a)},fe=(s,t)=>{const a=[...h];a[s].result=t,j(a)},ve=(s,t)=>{const a=[...h];a[s].remarks=t,j(a)},Ne=s=>{const t=[];for(const a of s){const r=M.find(N=>N.employee_id===a.employee_id&&N.program_code===a.program_code&&N.training_date===a.training_date);if(r){const N=B.find(we=>we.employee_id===a.employee_id);t.push({employee_id:a.employee_id,employee_name:N?.employee_name||a.employee_id,existingResult:{training_date:r.training_date,score:r.score,result:r.result,grade:r.grade}})}}return t},ye=async()=>{if(!d||!g)return;const s=h.map(a=>({session_id:d.session_id,employee_id:a.employee_id,program_code:d.program_code,training_date:d.session_date,score:a.score,result:a.result,evaluated_by:"admin",remarks:a.remarks})),t=Ne(s);if(t.length>0){V(t),$(s),v(!0);return}await q(s)},q=async s=>{try{await me(s),x({type:"success",title:n("messages.saveSuccess"),description:`${s.length}건의 결과가 저장되었습니다`}),O(""),j([]),v(!1),V([]),$([])}catch{x({type:"error",title:n("messages.saveError")})}},_e=async()=>{const s=w.filter(t=>!u.some(a=>a.employee_id===t.employee_id));if(s.length===0){x({type:"error",title:"저장할 결과 없음",description:"모든 결과가 이미 입력되어 있습니다."}),v(!1);return}await q(s),x({type:"info",title:"중복 제외 저장",description:`${u.length}건의 중복 결과가 제외되었습니다.`})},Se=s=>{p({result_id:s.result_id,score:s.score,result:s.result,remarks:s.remarks||"",editReason:""}),b(!0)},Ce=async()=>{if(!l||!l.editReason){x({type:"error",title:n("messages.editReasonRequired")});return}try{await xe(l.result_id,{score:l.score,result:l.result,remarks:l.remarks},l.editReason),x({type:"success",title:n("messages.saveSuccess")}),b(!1),p(null),H({})}catch{x({type:"error",title:n("messages.saveError")})}},be=(s,t)=>!s||!t?null:s>=t.grade_aa?"AA":s>=t.grade_a?"A":s>=t.grade_b?"B":"C";if(S.sessions||S.programs||S.employees)return e.jsx(Ee,{});const z=I.filter(s=>s.status==="PLANNED"&&s.attendees.length>0);return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:n("nav.results")}),e.jsx("p",{className:"text-muted-foreground",children:"교육 결과를 입력하고 관리하세요. 결과는 삭제할 수 없습니다."})]})}),e.jsxs(G,{children:[e.jsxs(U,{children:[e.jsx(W,{children:"결과 입력"}),e.jsx(J,{children:"교육 세션을 선택하고 참석자들의 결과를 입력하세요"})]}),e.jsx(K,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex gap-4",children:e.jsxs("div",{className:"flex-1",children:[e.jsx(_,{children:"교육 세션 선택"}),e.jsxs(E,{value:C,onValueChange:O,children:[e.jsx(k,{children:e.jsx(T,{placeholder:"세션을 선택하세요"})}),e.jsx(L,{children:z.length===0?e.jsx(o,{value:"none",disabled:!0,children:"결과 입력 가능한 세션이 없습니다"}):z.map(s=>e.jsxs(o,{value:s.session_id,children:[P(new Date(s.session_date),"yyyy-MM-dd")," | ",s.program_code," | ",s.attendees.length,"명"]},s.session_id))})]})]})}),d&&g&&e.jsx("div",{className:"p-4 bg-muted rounded-lg",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"프로그램"}),e.jsx("p",{className:"font-medium",children:g.program_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"날짜"}),e.jsx("p",{className:"font-medium",children:P(new Date(d.session_date),"yyyy-MM-dd")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"합격 점수"}),e.jsxs("p",{className:"font-medium",children:[g.passing_score,"점 이상"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"참석자"}),e.jsxs("p",{className:"font-medium",children:[d.attendees.length,"명"]})]})]})}),h.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(X,{children:[e.jsx(Y,{children:e.jsxs(D,{children:[e.jsx(i,{className:"w-[120px]",children:"사번"}),e.jsx(i,{children:"이름"}),e.jsx(i,{className:"w-[100px] text-center",children:"점수"}),e.jsx(i,{className:"w-[100px] text-center",children:"등급"}),e.jsx(i,{className:"w-[150px] text-center",children:"결과"}),e.jsx(i,{children:"비고"})]})}),e.jsx(Z,{children:h.map((s,t)=>{const a=be(s.score,g);return e.jsxs(D,{children:[e.jsx(c,{className:"font-mono",children:s.employee_id}),e.jsx(c,{className:"font-medium",children:s.employee_name}),e.jsx(c,{children:e.jsx(y,{type:"number",min:"0",max:"100",value:s.score??"",onChange:r=>pe(t,r.target.value),className:"w-20 text-center",placeholder:"점수"})}),e.jsx(c,{className:"text-center",children:a&&e.jsx(R,{variant:a==="AA"?"gradeAA":a==="A"?"gradeA":a==="B"?"gradeB":"gradeC",children:a})}),e.jsx(c,{children:e.jsxs(E,{value:s.result,onValueChange:r=>fe(t,r),children:[e.jsx(k,{className:"w-[120px]",children:e.jsx(T,{})}),e.jsxs(L,{children:[e.jsx(o,{value:"PASS",children:n("training.pass")}),e.jsx(o,{value:"FAIL",children:n("training.fail")}),e.jsx(o,{value:"ABSENT",children:n("training.absent")})]})]})}),e.jsx(c,{children:e.jsx(y,{value:s.remarks,onChange:r=>ve(t,r.target.value),placeholder:"비고"})})]},s.employee_id)})})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(f,{onClick:ye,children:[e.jsx(le,{className:"h-4 w-4 mr-2"}),"결과 저장"]})})]}),C&&h.length===0&&e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"이 세션에 등록된 참석자가 없습니다"})]})})]}),e.jsxs(G,{children:[e.jsx(U,{children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(W,{children:"최근 결과"}),e.jsx(J,{children:"입력된 교육 결과 목록 (수정 가능, 삭제 불가)"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Te,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(y,{placeholder:"검색...",className:"pl-8 w-[200px]",value:A,onChange:s=>ge(s.target.value)})]}),e.jsxs(E,{value:F,onValueChange:je,children:[e.jsx(k,{className:"w-[120px]",children:e.jsx(T,{})}),e.jsxs(L,{children:[e.jsx(o,{value:"all",children:n("common.all")}),e.jsx(o,{value:"PASS",children:n("training.pass")}),e.jsx(o,{value:"FAIL",children:n("training.fail")}),e.jsx(o,{value:"ABSENT",children:n("training.absent")})]})]})]})]})}),e.jsx(K,{children:S.results?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:n("common.loading")})}):Q.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:n("common.noData")}):e.jsxs(X,{children:[e.jsx(Y,{children:e.jsxs(D,{children:[e.jsx(i,{children:n("training.date")}),e.jsx(i,{children:"사번"}),e.jsx(i,{children:"프로그램"}),e.jsx(i,{className:"text-center",children:n("training.score")}),e.jsx(i,{className:"text-center",children:n("training.grade")}),e.jsx(i,{className:"text-center",children:n("training.result")}),e.jsx(i,{children:n("training.trainer")}),e.jsx(i,{className:"w-[80px]",children:n("common.actions")})]})}),e.jsx(Z,{children:Q.slice(0,20).map(s=>e.jsxs(D,{children:[e.jsx(c,{children:P(new Date(s.training_date),"yyyy-MM-dd")}),e.jsx(c,{className:"font-mono",children:s.employee_id}),e.jsx(c,{children:e.jsx(R,{variant:"outline",children:s.program_code})}),e.jsx(c,{className:"text-center",children:s.score!==null?`${s.score}점`:"-"}),e.jsx(c,{className:"text-center",children:s.grade&&e.jsx(R,{variant:s.grade==="AA"?"gradeAA":s.grade==="A"?"gradeA":s.grade==="B"?"gradeB":"gradeC",children:s.grade})}),e.jsx(c,{className:"text-center",children:e.jsx(R,{variant:s.result==="PASS"?"success":s.result==="FAIL"?"destructive":"secondary",children:s.result==="PASS"?n("training.pass"):s.result==="FAIL"?n("training.fail"):n("training.absent")})}),e.jsx(c,{children:s.evaluated_by}),e.jsx(c,{children:e.jsx(f,{variant:"ghost",size:"icon",onClick:()=>Se(s),children:e.jsx(Le,{className:"h-4 w-4"})})})]},s.result_id))})]})})]}),e.jsx(ee,{open:he,onOpenChange:b,children:e.jsxs(se,{children:[e.jsxs(ae,{children:[e.jsx(ne,{children:"결과 수정"}),e.jsx(te,{children:"수정 사유를 반드시 입력해야 합니다. 수정 이력은 기록됩니다."})]}),l&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"점수"}),e.jsx(y,{type:"number",min:"0",max:"100",value:l.score??"",onChange:s=>p({...l,score:s.target.value===""?null:parseInt(s.target.value)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"결과"}),e.jsxs(E,{value:l.result,onValueChange:s=>p({...l,result:s}),children:[e.jsx(k,{children:e.jsx(T,{})}),e.jsxs(L,{children:[e.jsx(o,{value:"PASS",children:n("training.pass")}),e.jsx(o,{value:"FAIL",children:n("training.fail")}),e.jsx(o,{value:"ABSENT",children:n("training.absent")})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"비고"}),e.jsx(y,{value:l.remarks,onChange:s=>p({...l,remarks:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{className:"text-destructive",children:"수정 사유 *"}),e.jsx(De,{value:l.editReason,onChange:s=>p({...l,editReason:s.target.value}),placeholder:"수정 사유를 입력하세요 (필수)",className:"min-h-[80px]"})]})]}),e.jsxs(re,{children:[e.jsx(f,{variant:"outline",onClick:()=>b(!1),children:n("common.cancel")}),e.jsxs(f,{onClick:Ce,children:[e.jsx(Pe,{className:"h-4 w-4 mr-2"}),"수정 저장"]})]})]})}),e.jsx(ee,{open:ue,onOpenChange:v,children:e.jsxs(se,{className:"max-w-lg",children:[e.jsxs(ae,{children:[e.jsxs(ne,{className:"flex items-center gap-2 text-amber-600",children:[e.jsx(Be,{className:"h-5 w-5"}),"중복 결과 감지"]}),e.jsx(te,{children:"다음 직원들은 이미 같은 날짜에 같은 프로그램의 결과가 입력되어 있습니다."})]}),e.jsx("div",{className:"space-y-3 max-h-[300px] overflow-y-auto",children:u.map(s=>e.jsxs("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg",children:[e.jsxs("div",{className:"font-medium text-amber-800",children:[s.employee_name," (",s.employee_id,")"]}),e.jsxs("div",{className:"text-sm text-amber-700 mt-1",children:["기존 결과: ",P(new Date(s.existingResult.training_date),"yyyy-MM-dd")," |"," ",s.existingResult.score!==null?`${s.existingResult.score}점`:"-"," |"," ",s.existingResult.result==="PASS"?n("training.pass"):s.existingResult.result==="FAIL"?n("training.fail"):n("training.absent"),s.existingResult.grade&&` | ${s.existingResult.grade}등급`]})]},s.employee_id))}),e.jsxs("div",{className:"text-sm text-muted-foreground bg-muted p-3 rounded-md",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"저장 진행"}),": 중복된 ",u.length,"건을 제외하고"," ",w.length-u.length,"건만 저장합니다."]}),e.jsx("p",{className:"mt-1",children:"기존 결과를 수정하려면 '최근 결과' 목록에서 수정 버튼을 사용하세요."})]}),e.jsxs(re,{children:[e.jsx(f,{variant:"outline",onClick:()=>v(!1),children:n("common.cancel")}),e.jsxs(f,{onClick:_e,disabled:w.length-u.length===0,children:[e.jsx(le,{className:"h-4 w-4 mr-2"}),"중복 제외하고 저장 (",w.length-u.length,"건)"]})]})]})})]})}export{Je as default};
